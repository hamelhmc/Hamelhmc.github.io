---
import Layout from '@/layouts/Layout.astro';
import Briefcase from '@/components/icons/Briefcase.astro';
import Experience from '@/components/Experience.astro';
import SectionContainer from '@/components/SectionContainer.astro';
import Hero from '@/components/Hero.astro';
import Skills from '@/components/Skills.astro';
import AboutMe from '@/components/AboutMe.astro';
import Contact from '@/components/Contact.astro';
import Studies from '@/components/Studies.astro';
import Projects from '@/components/Projects.astro';
import type { Portafolio } from '@/data/model/manfred.interface';

// SSR: Fetch data at build time
const response = await fetch('https://raw.githubusercontent.com/hamelhmc/manfred/main/CV/MAC.json');
const data = await response.json();
const portafolio = data as Portafolio;

// SEO: Meta description
const aboutDescriptionParagraph = portafolio.aboutMe.profile.description.split('\n\n').slice(0, 2).join(' ').substring(0, 160);
---

<Layout
  title={`${portafolio.aboutMe.profile.name} ${portafolio.aboutMe.profile.surnames} - ${portafolio.aboutMe.profile.title
    .split('|')[0]
    .trim()}`}
  description={aboutDescriptionParagraph}
  ogImageUrl={'/assets/images/profile.jpg'}
  aboutMe={portafolio.aboutMe}
  careerPreferences={portafolio.careerPreferences}
  knowledge={portafolio.knowledge}>
  <!-- Hero Section -->
  <section class="pt-24" aria-label="Introducción">
    <Hero aboutMe={portafolio.aboutMe} careerPreferences={portafolio.careerPreferences} />
  </section>

  <!-- Main Content -->
  <div class="space-y-0">
    <!-- Experience Section -->
    <section id="experiencia" class="py-24 scroll-mt-20" aria-labelledby="experience-heading">
      <SectionContainer>
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
          <div class="text-center space-y-4">
            <span class="text-primary font-semibold text-sm tracking-[0.2em] uppercase">Trayectoria</span>
            <h2
              id="experience-heading"
              class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 dark:text-txt-primary tracking-tight">
              Experiencia profesional
            </h2>
            <p class="text-gray-600 dark:text-txt-secondary text-base md:text-lg max-w-xl mx-auto">
              4+ años construyendo aplicaciones web de alto rendimiento en sectores de e-commerce y banca.
            </p>
          </div>
        </div>
        <Experience experience={portafolio.experience} />
      </SectionContainer>
    </section>

    <!-- Skills Section -->
    <Skills knowledge={portafolio.knowledge} mainStackTechs={portafolio.manfredSpecificData.mainStackTechs} />

    <!-- Studies Section -->
    <Studies knowledge={portafolio.knowledge} />

    <!-- Projects Section -->
    <Projects experience={portafolio.experience} />

    <!-- About Me Section -->
    <AboutMe knowledge={portafolio.knowledge} aboutMe={portafolio.aboutMe} />

    <!-- Contact Section -->
    <Contact careerPreferences={portafolio.careerPreferences} />
  </div>
</Layout>

<!-- Client-side data refresh (daily) -->
<script>
  const CV_URL = 'https://raw.githubusercontent.com/hamelhmc/manfred/main/CV/MAC.json';
  const REFRESH_INTERVAL = 24 * 60 * 60 * 1000; // 24 hours
  const LAST_CHECK_KEY = 'cv_last_check';

  async function checkForUpdates() {
    try {
      const lastCheck = localStorage.getItem(LAST_CHECK_KEY);
      const now = Date.now();

      if (lastCheck && now - parseInt(lastCheck) < REFRESH_INTERVAL) {
        return; // Skip if checked within 24 hours
      }

      const response = await fetch(CV_URL, { cache: 'no-cache' });
      if (response.ok) {
        localStorage.setItem(LAST_CHECK_KEY, now.toString());
        console.log('[CV] Data check completed');
      }
    } catch (error) {
      console.warn('[CV] Failed to check for updates:', error);
    }
  }

  // Check on page load
  document.addEventListener('astro:page-load', () => {
    setTimeout(checkForUpdates, 5000); // Delay to not block initial render
  });
</script>
