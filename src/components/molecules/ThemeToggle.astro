---
import SunIcon from '../icons/Sun.astro';
import MoonIcon from '../icons/Moon.astro';
import SystemIcon from '../icons/System.astro';

const THEMES = ['Light', 'Dark', 'System'];
---

<div class="relative block">
  <button
    id="theme-toggle-btn"
    aria-haspopup="true"
    aria-expanded="false"
    aria-controls="themes-menu"
    aria-label="Cambiar tema"
    class="appearance-none border-none flex items-center focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 hover:scale-125 transition px-4 py-2 md:px-4 md:py-2 text-primary-600 dark:text-primary-400">
    <span class="sr-only">Cambiar tema - Elige entre claro, oscuro o predeterminado del sistema</span>
    <SunIcon id="light" class="theme-toggle-icon size-5 transition-all" />
    <MoonIcon id="dark" class="theme-toggle-icon size-5 transition-all" />
    <SystemIcon id="system" class="theme-toggle-icon size-5 transition-all" />
  </button>
  <div
    id="themes-menu"
    role="menu"
    aria-labelledby="theme-toggle-btn"
    tabindex="-1"
    class="absolute opacity-0 scale-80 top-8 right-0 text-sm p-1 min-w-[8rem] rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-[#1a1a1a] shadow-xl backdrop-blur-none z-50">
    <ul>
      {
        THEMES.map((theme) => (
          <li>
            <button
              role="menuitem"
              class="themes-menu-option w-full text-left px-4 py-2.5 cursor-pointer text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800/80 hover:text-primary-600 dark:hover:text-primary-400 rounded-lg transition-colors font-medium focus:outline-none focus:bg-gray-100 dark:focus:bg-gray-800/80"
              aria-label={`Usar tema ${theme}`}>
              {theme}
            </button>
          </li>
        ))
      }
    </ul>
  </div>
</div>

<style>
  #themes-menu.open {
    animation: scale-up-center 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  }

  @keyframes scale-up-center {
    0% {
      transform: scale(0.8);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>

<script>
  // Use astro:page-load to ensure this runs on every navigation
  document.addEventListener('astro:page-load', () => {
    const themesMenu = document.getElementById('themes-menu');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    
    if (!themesMenu || !themeToggleBtn) return;

    const getThemePreference = (): string => {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme') || 'light';
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };

    const updateIcon = (themePreference: string) => {
      document.querySelectorAll('.theme-toggle-icon').forEach((element) => {
        // Safe cast to HTMLElement for accessing style
        (element as HTMLElement).style.display = element.id === themePreference ? 'block' : 'none';
      });
    };

    const updateTheme = () => {
      try {
        const themePreference = getThemePreference();
        const isDark =
          themePreference === 'dark' || (themePreference === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        document.documentElement.classList.toggle('dark', isDark);
        updateIcon(themePreference);
        
        // Optional: Persist if missing? No, only on explicit change.
      } catch (e) {
        console.warn('Error updating theme:', e);
      }
    };

    // Initial check
    updateTheme();

    // Event Listeners
    const clickOutsideHandler = (e: MouseEvent) => {
      if (themesMenu && !themesMenu.contains(e.target as Node) && !themeToggleBtn.contains(e.target as Node)) {
        themesMenu.classList.remove('open');
        themeToggleBtn.setAttribute('aria-expanded', 'false');
      }
    };

    // Use a clean listener setup
    document.addEventListener('click', clickOutsideHandler);

    themeToggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = themesMenu.classList.toggle('open');
      themeToggleBtn.setAttribute('aria-expanded', String(isOpen));
    });

    document.querySelectorAll('.themes-menu-option').forEach((element) => {
      element.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const newTheme = target.innerText.toLowerCase().trim();
        
        try {
          localStorage.setItem('theme', newTheme);
          updateTheme();
        } catch (err) {
          console.error('Failed to save theme preference:', err);
        }
        
        themesMenu.classList.remove('open');
        themeToggleBtn.setAttribute('aria-expanded', 'false');
      });
    });
  });
</script>
